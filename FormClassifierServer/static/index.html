<!doctype html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>Ninder</title>
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/css/materialize.min.css">
	</head>
	<body>
		<div class="container">
			<div class="section">
				<p>URL: <span id="url"></span></p>
				<div class="row">
					<div class="col s6">
						<a id="btnNotForm" class="waves-effect waves-light btn pink" style="width: 100%"><i class="material-icons left">arrow_back</i>!Form</a>
					</div>
					<div class="col s6">
						<a id="btnForm" class="waves-effect waves-light btn deep-purple darken-2" style="width: 100%"><i class="material-icons right">arrow_forward</i>Form</a>
					</div>
				</div>
				<img id="screenshot" class="responsive-img" src="">
			</div>
		</div>
		<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
		<script type="text/javascript" src="js/hammer.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.1/js/materialize.min.js"></script>
		<script type="text/javascript">
			var nextImage = new Image();

			var currentPage = null;
			var nextPage = null;

			var classifyAsForm = function(isForm) {
				return new Promise((resolve, reject) => {
					$.ajax({
						type: "post",
						url: "/classify",
						contentType: "application/json",
						data: JSON.stringify({url: currentPage.url, isForm: isForm}),
						dataType: "json",
						success: data => {
							Materialize.toast("Classified as " + (isForm ? "form" : "not form"), 1000);
							loadNewPage()
								.catch(error => console.log(error));
							resolve(data);
						},
						error: (jqXHR, textStatus, errorThrown) => {
							Materialize.toast("Classification error", 1000);
							reject(errorThrown);
						}
					});
				});
			};

			var getPageToClassify = function() {
				return new Promise((resolve, reject) => {
					$.ajax({
						url: "/classify", 
						dataType: "json",
						success: data => {
							resolve(data);
						},
						error: (jqXHR, textStatus, errorThrown) => {
							reject(errorThrown);
						}
					});
				});
			}

			var getPageDifferentFrom = function(page, retryNumber = 0) {
				return new Promise((resolve, reject) => {
					if (retryNumber > 3) {
						console.log("Different page retries limit exceeded");
						resolve({
							url: "",
							imageUrl: ""
						});
					} else {
						getPageToClassify()
							.then(result => {
								if (page === null || page.url !== result.url) {
									resolve(result);
								} else {
									getPageDifferentFrom(page.url, retryNumber + 1)
										.then(result => resolve(result))
										.catch(error => console.log(error));
								}
							})
							.catch(error => {
								resolve({
									url: "",
									imageUrl: ""
								});
							});
					}
				});
				
			} 

			var loadNewPage = async function() {
				if (nextPage === null) { // first page loaded
					nextPage = await getPageDifferentFrom(currentPage);
				}

				// update current page
				currentPage = {
					url: nextPage.url,
					imageUrl: nextPage.imageUrl
				};
				// update UI to current page
				$("#screenshot").attr("src", currentPage.imageUrl);
				$("#url").text(currentPage.url);

				
				// preload next page
				nextPage = await getPageDifferentFrom(currentPage);
				// load next page image to browser cache
				(new Image()).src = nextPage.imageUrl;
			}

			$(document).ready(function() {
				var screenshotHammer = new Hammer(document.getElementById("screenshot"));

				// detect keypresses
				$(document).keypress(function(e) {
					switch(e.keyCode) {
						case 74: // J
						case 106: // j
							classifyAsForm(false)
								.catch(error => console.log(error));
							break;
						case 75: // K
						case 107: // k
							classifyAsForm(true)
								.catch(error => console.log(error));
							break;
						default:
					}
				});

				// Classify as not form
				screenshotHammer.on('swipeleft', function(ev) {
					classifyAsForm(false)
						.catch(error => console.log(error));
				});

				$("#btnNotForm").click(function() {
					classifyAsForm(false)
						.catch(error => console.log(error));
				});


				// Classify as form
				screenshotHammer.on('swiperight', function(ev) {
					classifyAsForm(true)
						.catch(error => console.log(error));
				});
				$("#btnForm").click(function() {
					classifyAsForm(true)
						.catch(error => console.log(error));
				});

				// load first page
				loadNewPage()
					.catch(error => console.log(error));
			});
			
		</script>
	</body>
</html>